{% extends 'layout.html' %}

{% block title -%}Offline Audio - Te K≈çhanga{%- endblock %}
{% block page_name -%}Offline Audio{%- endblock %}
{% block breadcrumb -%}ASR and Emotion Detection - Offline Audio Data{%- endblock %}

{% block main %}
<div class="container mt-4">
    <!-- Upload Form and Results -->
    <div id="uploadFormCard" class="card text-center mb-4">
        <div class="card-header">
            <h4>Upload Your Audio File for ASR and Emotion Detection</h4>
        </div>
        <div class="card-body">
            <!-- Upload Form -->
            <form id="audioUploadForm">
                <input type="file" id="audioFile" name="files[]" multiple />
                <br><br>
                <button id="submitButton" class="btn btn-secondary" type="submit">Submit</button>
            </form>

            <!-- Processing State -->
            <div id="processingState" class="mt-3" style="display: none;">
                <h5>Processing your audio...</h5>
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <br>
            <!-- Results -->
            <div id="resultCard" class="mt-3" style="display: none;">
                <h5>ASR Results:</h5>
                <div style="display: flex; justify-content: center; align-items: center;">
                    <textarea id="transcriptionOutput" rows="5" cols="50" class="form-control" readonly
                        style="width: auto; min-width: 100px; max-width: 700px;"></textarea>
                </div>
                <br>
                <h5>Emotion Detected:</h5>
                <div style="display: flex; justify-content: center; align-items: center;">
                    <textarea id="emotionOutput" rows="1" cols="15" class="form-control" readonly
                        style="width: auto; min-width: 100px; max-width: 200px;"></textarea>
                </div>
                <br>
                <button id="testAgainButton" class="btn btn-secondary">Test Again</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script_function %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const audioUploadForm = document.getElementById('audioUploadForm');
        const processingState = document.getElementById('processingState');
        const resultCard = document.getElementById('resultCard');
        const transcriptionOutput = document.getElementById('transcriptionOutput');
        const emotionOutput = document.getElementById('emotionOutput');
        const testAgainButton = document.getElementById('testAgainButton');
        const submitButton = document.getElementById('submitButton');

        // Handle Form Submission
        audioUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = document.getElementById('audioFile').files;
            if (!files.length) {
                alert("Please select a file to upload.");
                return;
            }

            // Show Processing State
            audioUploadForm.style.display = 'none';
            processingState.style.display = 'block';
            resultCard.style.display = 'none';

            const formData = new FormData();
            Array.from(files).forEach(file => formData.append('files', file));

            try {
                const response = await fetch('/upload-audio', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                // Populate Results
                transcriptionOutput.value = data.transcription || 'No transcription available.';
                emotionOutput.value = data.emotion || 'No emotion detected.';

                // Show Results
                processingState.style.display = 'none';
                resultCard.style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                alert('Error occurred. Please try again.');
                processingState.style.display = 'none';
            } 
        });

        // Reset Form for New Test
        testAgainButton.addEventListener('click', () => {
            resultCard.style.display = 'none';
            transcriptionOutput.value = '';
            emotionOutput.value = '';
            audioUploadForm.style.display = '';
            audioUploadForm.reset(); // Reset the form, including the file input field
            
        });
    });
</script>
{% endblock %}